<div class="container">
    <h1>Clustering Debug Tool</h1>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Debug Options</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('debug.debug_clustering') }}">
                        <div class="form-group">
                            <label for="location_id">Location ID (optional):</label>
                            <input type="number" class="form-control" id="location_id" name="location_id" 
                                   placeholder="Enter specific location ID or leave empty for recent locations" 
                                   value="{{ location_id or '' }}">
                        </div>
                        
                        <button type="submit" class="btn btn-primary mt-2">Run Debug</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Quick Location Search</h5>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="search-street" 
                               placeholder="Search by street name...">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" id="search-btn">
                                Search
                            </button>
                        </div>
                    </div>
                    
                    <div id="search-results" class="mt-3">
                        <!-- Search results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <div class="card">
        <div class="card-header">
            <h5>Debug Output</h5>
        </div>
        <div class="card-body">
            <pre class="debug-output">{{ debug_output }}</pre>
        </div>
    </div>
</div>

<style>
    .debug-output {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 600px;
        overflow-y: auto;
    }
    .location-item {
        cursor: pointer;
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    .location-item:hover {
        background-color: #f8f9fa;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchBtn = document.getElementById('search-btn');
        const searchInput = document.getElementById('search-street');
        const searchResults = document.getElementById('search-results');
        
        // Handle search button click
        searchBtn.addEventListener('click', function() {
            const searchTerm = searchInput.value.trim();
            if (searchTerm.length < 3) {
                searchResults.innerHTML = '<div class="alert alert-info">Please enter at least 3 characters</div>';
                return;
            }
            
            // Show loading indicator
            searchResults.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Searching...</div>';
            
            // Perform search
            fetch(`/clustering/search_locations?query=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (data.locations.length > 0) {
                            let html = '<div class="list-group">';
                            data.locations.forEach(loc => {
                                html += `
                                    <div class="location-item" data-location-id="${loc.id}">
                                        <strong>${loc.street || 'No street name'}</strong><br>
                                        <small>${loc.development || loc.neighborhood || ''}</small>
                                    </div>
                                `;
                            });
                            html += '</div>';
                            searchResults.innerHTML = html;
                            
                            // Add click event to location items
                            document.querySelectorAll('.location-item').forEach(item => {
                                item.addEventListener('click', function() {
                                    const locId = this.dataset.locationId;
                                    document.getElementById('location_id').value = locId;
                                    document.querySelector('form').submit();
                                });
                            });
                        } else {
                            searchResults.innerHTML = '<div class="alert alert-warning">No locations found</div>';
                        }
                    } else {
                        searchResults.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                    }
                })
                .catch(error => {
                    searchResults.innerHTML = '<div class="alert alert-danger">Error performing search</div>';
                    console.error(error);
                });
        });
        
        // Allow search on Enter key
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBtn.click();
                e.preventDefault();
            }
        });
    });
</script>